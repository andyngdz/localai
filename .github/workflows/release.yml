# Workflow name
name: Release

# Triggers for the workflow
on:
  push:
    branches:
      - main
      - develop

# Permissions required by semantic-release
permissions:
  contents: write # To create releases and push commits
  issues: write # To comment on issues
  pull-requests: write # To comment on PRs

# Define the jobs to be executed
jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    # Only run if the commit is not from semantic-release itself
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      # Step 1: Checkout the repository with full history
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for semantic-release
          persist-credentials: false # Use GITHUB_TOKEN instead

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
          cache: 'npm'

      # Step 7: Run semantic-release
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: semantic-release-bot
          GIT_AUTHOR_EMAIL: semantic-release-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: semantic-release-bot
          GIT_COMMITTER_EMAIL: semantic-release-bot@users.noreply.github.com
        run: npx semantic-release

      # Step 8: Report release status
      - name: Report Release Status
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseStatus = "${{ job.status }}" === "success" ? "‚úÖ" : "‚ùå";

            const body = `## Release Status

            | Status | Result |
            |--------|--------|
            | Release | ${releaseStatus} |

            ${releaseStatus === "‚ùå" ?
              "‚ö†Ô∏è Release failed. Please check the logs for details." :
              "üéâ Release completed successfully!"}`;

            console.log(body);
